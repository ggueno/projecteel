{% extends "layout/base.html" %}
{% load thumbnail %}

{% block title %} Mes offres {% endblock %}
{% block content %}

<div class="row posted_offers">
    <h1 class="heading">Mes offres</h1>

    {% if offers %}

        {% if offers.count > 1 %}
            <p class="nb_offers"><span>{{ offers.count }}</span> offres postées</p>
        {% else %}
            <p class="nb_offers"><span>{{ offers.count }}</span> offre postée</p>
        {% endif %}

    {% for offer in offers %}

    <div class="list_offers">

        <section class="thumb-offer ninecol">

            <div class="content content-description">

                <div class="left">
                    <h3><a href="/offer/get/{{ offer.slug }}">{{ offer.title }}</a></h3>
                    <p>{{ offer.location }}</p>
                    {% if offer.tags %}
                        <ul class="tags-offer">
                        {% for tag in offer.tags.all %}
                            <li><a href="/offers/search/?tags[]={{tag.slug}}">{{ tag.name }}</a></li>
                        {% endfor %}
                        </ul>
                    {% endif %}
                </div>

                <div class="right">
                    <a class="mini" href="/offer/edit/{{ offer.slug }}">
                        <i class="ico-cog"></i>
                    </a>
                    <p class="publish-date">{{ offer.publish_date }}</p>
                    <span>{{ offer.get_contract_display }}</span>
                </div>
                    
            </div> <!-- end div content-description -->

            <div class="candidates">

                <div class="content">

                {% if offer.vacancy == 0 %}
                    {% if applications %}

                        <h4>Candidats:</h4>

                        {% for application in applications %}

                            {% if application.offer == offer and application.state != 'FAIL' %}

                                <div class="applicant">

                                    {% thumbnail application.applicant.avatar "50x50" crop="left" as im %}
                                        <a href="/profile/{{ application.applicant.slug }}" data-tooltip="{{ application.applicant.user}}" class="tooltip">
                                        <img src="{{im.url}}" alt="{{ application.applicant.name }}"/>
                                        </a>
                                    {% endthumbnail %}

                                    <p class="name-applicant">{{application.applicant.name}}</p>
                                    <p class="publish-date">{{ offer.publish_date }}</p>

                                    <a class="PTbutton mini view-candidature" href="/offer/statusApplication/read/{{application.id}}/{{application.applicant.slug}}/" id="{{application.id}}"><i id="i{{application.id}}" class="ico-chevron-right"></i></a>

                                </div> <!-- end div applicant -->

                            {% endif %}

                        {% endfor %}

                        {% for application in applications %}
                                            
                                <div class="content-application" id="application{{application.id}}">
                                    <div class="content">
                                        <p>{{ application.content }}</p>

                                        {% if application.state == 'SAVE' %}
                                            <p>Vous avez retenue ce candidat,contactez-le :<span>{{ application.applicant.user.email }}</span></p>
                                        {% else %}
                                            <a class="PTbutton reserve" href="/offer/statusApplication/accept/{{application.id}}/{{application.applicant.slug}}/"><i class="ico-ok"></i>Retenir cette candidature</a>
                                        {% endif %}
                                        <a class="PTbutton button-vacancy" href="/offer/statusApplication/decline/{{application.id}}/{{application.applicant.slug}}/"><i class="ico-ban-circle"></i>Refuser cette candidature</a>
                                    </div>
                                </div>

                        {% endfor %}

                            
                        <div class="clearfix"></div>

                    {% endif %}
                </div>

            </div><!-- end div candidates -->

            <a href="/offer/vacancy/add/{{offer.id}}/" class="PTbutton button-vacancy" id="vacancy"><i class="ico-trash"></i>Déclarer pourvue</a>

            {% else %}

                <div class="novacancy">
                    <p>Vous avez déclaré cette offre pourvue.</p>
                </div>
                </div>

            </div>
                <a class="PTbutton button-novacancy" href="/offer/vacancy/unadd/{{offer.id}}/" id="vacancy">Déclarer disponible</a>

            {% endif %}

        </section> <!-- end section thumb nine col -->

        <section class="threecol last suggest_candidates">
            <h4>Candidats suggérés :</h4>

            {% if potentials %}

                {% for potential in potentials|slice:":6" %}

                    <div class="potential-applicant" id="applicant{{potential.id}}">

                        <a class="remove-candidate" id="{{potential.id}}" href="#"><i class="ico-remove"></i></a>
                        {% thumbnail potential.avatar "50x50" crop="left" as im %}
                            <a href="/profile/{{ potential.slug }}" data-tooltip="{{ potential.user}}" class="tooltip">
                            <img src="{{im.url}}" alt="{{ potential.name }}"/>
                            </a>
                        {% endthumbnail %}
                        <p>{{ potential.name }}</p>

                    </div>

                {% endfor %}      

            {% endif %}

        </section>

    </div> <!-- end posted_offer row -->

    {% endfor %}
    
    {% endif %}
</div>

{% endblock %}

{% block js %}

<script type="text/javascript">

    $(document).ready(function(){

        onoff_button('#vacancy', 'add', "Déclarer pourvue", "Déclarer disponible");

        $('.content-application').hide();
        $('.view-candidature').click(function() {
            var id = '#application'+this.id;
            var ico_id = this.id;
            if ($(id).is(":visible")) {
                $(id).hide();
                $('#i'+ico_id).removeClass('ico-chevron-down');
                $('#i'+ico_id).addClass('ico-chevron-right');
            } else {
                $.post($(this).attr('href'),function(data){
                    $(id).show();       
                    $('#i'+ico_id).removeClass('ico-chevron-right');
                    $('#i'+ico_id).addClass('ico-chevron-down');
                });
                $('.content-application').hide();
            }
            return false;
        });


        $('.reserve').click(function() {
            $.post($(this).attr('href'),function(data){

                //<p>Vous avez retenue ce candidat,contactez-le :<span>{{ application.applicant.user.email }}</span></p>
            });
            return false;
        });


        $('.remove-candidate').click(function() {
            var id = '#applicant'+this.id;
            $(id).hide();
            return false;
        });

        /*$('#vacancy').click(function(){
            $.post($(this).attr('href'),function(data){

            });

            /*var button = this;
            $.post($(this).attr('href'),function(data){
                if(data==true || data.state == true)
                    if($(button).hasClass('unactive')){
                        var link = $(button).attr('href').replace(name,'un'+name);
                        $(button).attr('href',link);
                        $(button).removeClass('unactive');
                        $(button).addClass('active');
                        $(button).html(active);
                        //TODO : Add Unfollow hover
                    }else{
                        var link = $(button).attr('href').replace('un'+name,name);
                        $(button).attr('href',link);
                        $(button).addClass('unactive');
                        $(button).removeClass('active');
                        $(button).html(unactive);
                    }
            });
            return false;
        });*/

    });
</script>

{% endblock %}