{% extends "layout/base.html" %}
{% load staticfiles %}

{% block title %} Projects {% endblock %}
{% block content %}

    <div class="row wrapper">
        <h1 class="heading">Projects</h1>

        <div class="sorting threecol">
            <select id="search-categories" name="search-categories">
                <option value="all">Tous les catégories</option>
                {% for categorie in categories %}
                <option value="{{categorie.slug}}">{{categorie.name}}</option>
                {% endfor %}
            </select>

            <select id="search-filter" name="search-filter">
                <option value="pushs">Les plus pushés</option>
                <!-- <option value="views">Les plus vues</option> -->
                <option value="comments">Les plus commentés</option>
                <option value="recents">Les plus récents</option>
            </select>

            <select id="search-when" name="search-when">
                <option value="1">Aujourd'hui</option>
                <option value="7">Cette semaine</option>
                <option value="30">Ce mois</option>
                <option value="0" selected>Toujours</option>
            </select>



            <div class="sleekbox">
                <h4>Affiner ma recherche</h4>
                <p>Mots-clés</p>
                <input type="text" id="search-tags" name="keywords-sorting">
                <p>Localisation</p>
                <input class="search-field" id="search-location" type="text" name="location">
                <p>Compétences</p>
                <input type="text" id="search-skills">
                <p>Durée</p>
                <input type="text" id="search-durationmin">
                <input type="text" id="search-durationmax">
            </div>
        </div>

        <div class="list-offers eightcol">

            <form action="/projects/search/" class="project-search" method="get">
                {% csrf_token %}
                <input class="search-field" id="search-query" type="text" name="query">
                <input type="submit">
            </form>

            {% include endless_part %}

        </div>
    </div>
{% endblock %}

{% block js %}
    <script src="{{ STATIC_URL }}js/jquery.autoSuggest.minified.js"></script>
    <script src="{{ STATIC_URL }}endless_pagination/js/endless-pagination.js"></script>
    <script>
        $.endlessPaginate({
            paginateOnScroll: true,
            paginateOnScrollMargin: 20
        });



        var searchEngine = {
            search_url : "",
            search_datas : "",
            container : "",

            init : function(){
                this.search_url = $(".project-search").attr('action');
                this.search_datas = new Array();

                //foreach search-field
                var that = this;

                $('#search-categories').change(function(){
                    that.addToSearch('categories', $(this).val(), true)
                    return false;
                });

                $('#search-when').change(function(){
                    that.addToSearch('when', $(this).val(), true)
                    return false;
                });

                $('#search-filter').change(function(){
                    that.addToSearch('filter', $(this).val(), true)
                    return false;
                });

                $("#search-location").autoSuggest("/locations/list/",
                {
                    minChars: 2,
                    matchCase: true,
                    resultClick: function(elem){ that.addToSearch("location", elem.attributes.name, false); return elem;  },
                    selectionAdded: function(elem){ return elem;},
                    selectionRemoved: function(elem){
                        var id = $(elem).parent().attr('id').replace('as-selections-','');

                        that.removeFromSearch($("#as-input-"+id).attr('name'), $(elem).data('value'));
                        $(elem).remove();
                    }
                });

                $("#search-skills").autoSuggest("/list/skills/",
                {
                    minChars: 2,
                    matchCase: true,
                    resultClick: function(elem){ that.addToSearch("skills", elem.attributes.name, false); return elem;  },
                    selectionAdded: function(elem){ return elem;},
                    selectionRemoved: function(elem){
                        var id = $(elem).parent().attr('id').replace('as-selections-','');

                        that.removeFromSearch($("#as-input-"+id).attr('name'), $(elem).data('value'));
                        $(elem).remove();
                    }
                });

                 $("#search-tags").autoSuggest("/tags/list/",
                {
                    minChars: 2,
                    matchCase: true,
                    resultClick: function(elem){ that.addToSearch("tags", elem.attributes.name); return elem;  },
                    selectionAdded: function(elem){ return elem;},
                    selectionRemoved: function(elem){
                        var id = $(elem).parent().attr('id').replace('as-selections-','');

                        that.removeFromSearch($("#as-input-"+id).attr('name'), $(elem).data('value'));
                        $(elem).remove();
                    }
                });

                 $('#search-durationmin').keypress(function(e){
                    if(e.which == 13){
                        that.addToSearch('durationmin', $(this).val(), true);
                        return false;
                    }
                 });


                 $('#search-durationmax').keypress(function(e){
                    if(e.which == 13){
                        that.addToSearch('durationmax', $(this).val(), true)
                        return false;
                    }
                 });

                this.search_datas['location'] = new Array();
                this.search_datas['tags'] = new Array();
                this.search_datas['skills'] = new Array();
                this.search_datas['query'] = new Array();
                this.search_datas['durationmin'] = -1;
                this.search_datas['durationmax'] = -1;
                this.search_datas['when'] = 0;
                this.search_datas['filter'] = "pushs";

                $('#search-query').keypress(function(e) {
                    if(e.which == 13) {
                        that.addToSearch('query',$(this).val());
                        return false;
                    }
                });

                // $('.project-search').submit(function(){ return false; });

                    //If autocomplete

                    //If unique
            },

            addField : function () {},
            removeField : function() {},


            addToSearch : function(type, val, unique){
                if(unique){
                    this.search_datas[type] = val;
                }else{
                    this.search_datas[type].push(val);
                }
                this.sendSearch();
            },

            removeFromSearch : function(type, val, unique){
                if(unique){
                    this.search_datas[type].splice(val);
                }else{
                    this.search_datas[type] = -1;
                }
                this.sendSearch();
            },

            sendSearch : function(){
                var array = new Array;
                $.each(this.search_datas['location'], function(i, val){
                    array.push(val);
                });

                var that = { 
                    'location[]': this.search_datas['location'], 
                    'tags[]': this.search_datas['tags'], 
                    'skills[]': this.search_datas['skills'], 
                    'query[]': this.search_datas['query'],
                    'categories' : this.search_datas['categories'],
                    'when': this.search_datas['when'],
                    'filter': this.search_datas['filter']
                };

            
                if(this.search_datas['durationmin'] > 0){
                    that['durationmin'] = this.search_datas['durationmin'];;
                }


                if(this.search_datas['durationmax'] > 0){
                    that['durationmax'] = this.search_datas['durationmax'];
                }

                console.log(that);
                $.ajax({
                    type: "GET",
                    url : this.search_url,

                    traditional: true,
                    data : that,
                    success:
                        function(result, status){
                            $('.thumb').remove();
                            $(result).insertAfter(".project-search");
                        },
                });
            }
        }



        $().ready(function(){
            searchEngine.init();
        });

    </script>
{% endblock %}
