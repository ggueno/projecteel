{% extends "layout/base.html" %}
{% load staticfiles %}

{% block title %} Projects {% endblock %}
{% block content %}

    <div class="row wrapper">
        <h1 class="heading">Projects</h1>

        <div class="sorting threecol">
            <div class="sleekbox">
                <h4>Affiner ma recherche</h4>
                <p>Mots-clés</p>
                <input type="text" id="search-tags" name="keywords-sorting">
                <p>Localisation</p>
                <input class="search-field" id="search-location" type="text" name="location">
                <p>Secteur d'activité</p>
                <p>Type de contrat</p>
                <p>Durée</p>
            </div>
        </div>

        <div class="list-offers eightcol">

            <form action="/projects/search/" class="project-search" method="get">
                {% csrf_token %}
                <input class="search-field" id="search-query" type="text" name="query">
                <input type="submit">
            </form>

            {% include endless_part %}

        </div>
    </div>
{% endblock %}

{% block js %}
    <script src="{{ STATIC_URL }}js/jquery.autoSuggest.minified.js"></script>
    <script src="{{ STATIC_URL }}endless_pagination/js/endless-pagination.js"></script>
    <script>
        $.endlessPaginate({
            paginateOnScroll: true,
            paginateOnScrollMargin: 20
        });



        var searchEngine = {
            search_url : "",
            search_datas : "",
            container : "",

            init : function(){
                this.search_url = $(".project-search").attr('action');
                this.search_datas = new Array();

                //foreach search-field
                var that = this;

                $("#search-location").autoSuggest("/locations/list/",
                {
                    minChars: 2,
                    matchCase: true,
                    resultClick: function(elem){ that.addToSearch("location", elem.attributes.name); return elem;  },
                    selectionAdded: function(elem){ return elem;},
                    selectionRemoved: function(elem){
                        var id = $(elem).parent().attr('id').replace('as-selections-','');

                        that.removeFromSearch($("#as-input-"+id).attr('name'), $(elem).data('value'));
                        $(elem).remove();
                    }
                });

                 $("#search-tags").autoSuggest("/tags/list/",
                {
                    minChars: 2,
                    matchCase: true,
                    resultClick: function(elem){ that.addToSearch("tags", elem.attributes.name); return elem;  },
                    selectionAdded: function(elem){ return elem;},
                    selectionRemoved: function(elem){
                        var id = $(elem).parent().attr('id').replace('as-selections-','');

                        that.removeFromSearch($("#as-input-"+id).attr('name'), $(elem).data('value'));
                        $(elem).remove();
                    }
                });



                this.search_datas['location'] = new Array();
                this.search_datas['tags'] = new Array();

                $('#search-query').keypress(function(e) {
                    if(e.which == 13) {
                        addToSearch('query',$(this).query);
                        return false;
                    }
                });

                    //If autocomplete

                    //If unique
            },

            addField : function () {},
            removeField : function() {},


            addToSearch : function(type, val){

                this.search_datas[type].push(val);
                this.sendSearch();
            },

            removeFromSearch : function(type, val){
                console.log(type);
                console.log(val);
                this.search_datas[type].splice(val);
                this.sendSearch();
            },

            sendSearch : function(){
                var array = new Array;
                $.each(this.search_datas['location'], function(i, val){
                    array.push(val);
                });

                var that = { 'location[]': this.search_datas['location'], 'tags[]': this.search_datas['tags'] };
                console.log(that);
                $.ajax({
                    type: "GET",
                    url : this.search_url,

                    traditional: true,
                    data : that,
                    success:
                        function(result, status){
                            $('.thumb').remove();
                            $(result).insertAfter(".project-search");
                        },
                });
            }
        }



        $().ready(function(){
            searchEngine.init();
        });

    </script>
{% endblock %}
