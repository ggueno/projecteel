{% extends "layout/base.html" %}
{% load staticfiles %}


{% block title %} Projects {% endblock %}
{% block content %}

    <div class="row wrapper" id="projects">
        <h1 class="heading">Projects</h1>

        <div class="row PTform dropfilters">
            <div class="sixcol">
                <select class="search-field" id="search-categories" name="search-categories">
                    <option value="all">Tous les catégories</option>
                    {% for categorie in categories %}
                    <option value="{{categorie.slug}}">{{categorie.name}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="sixcol last">
                <select class="search-field" id="search-filter" name="search-filter">
                    <option value="pushs">Les plus pushés</option>
                    <!-- <option value="views">Les plus vues</option> -->
                    <option value="comments">Les plus commentés</option>
                    <option value="recents">Les plus récents</option>
                </select>
            </div>
        </div>


        <div class="sorting threecol">


            <div class="sleekbox PTform">

                <form action="/projects/search/" class="project-search" method="get">
                {% csrf_token %}
                <ul class="filters">
                    <li>
                        <input class="search-field" id="search-query" type="text" name="query" placeholder="Recherche...">
                    </li>
                </ul>
                </form>

                <form action="" id="projectFilters">
                    <ul class="filters">
                        <li class="tag">
                            <input class="search-field autocomplete" id="search-tags" type="text" name="keywords-sorting">
                        </li>
                        <li class="region">
                            <input class="search-field autocomplete" id="search-location" type="text" name="location">
                        </li>
                        <li class="tag">
                            <input class="search-field range" type="text" id="search-durationmin">
                            <input class="search-field range" type="text" id="search-durationmax">
                        </li>
                        <li>
                            <select class="search-field" id="search-when" name="search-when">
                                <option value="1">Aujourd'hui</option>
                                <option value="7">Cette semaine</option>
                                <option value="30">Ce mois</option>
                                <option value="0" selected>Toujours</option>
                            </select>
                        </li>
                        <li class="tag">
                            <input class="search-field autocomplete" type="text" id="search-skills" >
                        </li>
                    </ul>

            </div>
        </div>

        <div class="list-projects ninecol last">



            {% include endless_part %}

        </div>
    </div>
{% endblock %}

{% block js %}
    <script src="{{ STATIC_URL }}js/jquery.autoSuggest.minified.js"></script>
    <script src="{{ STATIC_URL }}endless_pagination/js/endless-pagination.js"></script>
    <script>
        $.endlessPaginate({
            paginateOnScroll: true,
            paginateOnScrollMargin: 20
        });



        var searchEngine = {
            search_url : "",
            search_datas : "",
            container : "",

            init : function(){
                this.search_url = $(".project-search").attr('action');
                this.search_datas = new Array();

                //foreach search-field
                var that = this;

                // Parcourir le DOM pour trouver des champs
                $('.search-field').each(function(index){
                    var title = $(this).attr('id').replace('search-','');
                    if( $(this).hasClass('autocomplete') ){

                        $(this).autoSuggest("/list/"+title+"/",
                        {
                            minChars: 2,
                            matchCase: false,
                            startText: title,
                            resultClick: function(elem){ that.addToSearch(title, elem.attributes.name, false); return elem;  },
                            selectionAdded: function(elem){ return elem;},
                            selectionRemoved: function(elem){
                                var id = $(elem).parent().attr('id').replace('as-selections-','');
                                console.log($("#as-input-"+id).attr('name'));
                                that.removeFromSearch(title, $(elem).data('value'));
                                $(elem).remove();
                            }
                        });
                        that.search_datas[title] = new Array();
                    }

                    else if( $(this).is('select') ){
                        $('#search-'+title).change(function(){
                            that.addToSearch(title, $(this).val(), true)
                            return false;
                        });

                        that.search_datas[title] = $(this).val();
                    }

                    else if( $(this).is('input') ){
                        $(this).keypress(function(e) {
                            if(e.which == 13) {
                                that.addToSearch(title,$(this).val(), true);
                                return false;
                            }
                        });



                        that.search_datas[title] = new Array();
                    }
                });




                 $('#search-durationmin').keypress(function(e){
                    if(e.which == 13){
                        that.addToSearch('durationmin', $(this).val(), true);
                        return false;
                    }
                 });


                 $('#search-durationmax').keypress(function(e){
                    if(e.which == 13){
                        that.addToSearch('durationmax', $(this).val(), true)
                        return false;
                    }
                 });



                this.search_datas['durationmin'] = -1;
                this.search_datas['durationmax'] = -1;



                $('.project-search').submit(function(){ return false; });
            },

            addField : function () {},
            removeField : function() {},


            addToSearch : function(type, val, unique){
                if(unique){
                    this.search_datas[type] = val;
                }else{
                    this.search_datas[type].push(val);
                }
                this.sendSearch();
            },

            removeFromSearch : function(type, val, unique){
                if(unique){
                    this.search_datas[type].splice(val);
                }else{
                    this.search_datas[type] = new Array();
                }
                this.sendSearch();
            },

            sendSearch : function(){

                var datas = new Object();
                for(key in this.search_datas) {
                    if(this.search_datas[key] != -1){
                        if(this.search_datas[key] instanceof Array){
                            datas[key+'[]'] = this.search_datas[key];
                        }else{
                            datas[key] = this.search_datas[key];
                        }
                    }
                }
                console.log(datas);

                $.ajax({
                    type: "GET",
                    url : this.search_url,

                    traditional: true,
                    data : datas,
                    success:
                        function(result, status){
                            $('.list-projects').empty().append(result);
                        },
                });
            }
        }



        $().ready(function(){
            searchEngine.init();
        });

    </script>
{% endblock %}
