{% extends "layout/base.html" %}
{% load staticfiles %}

{% block title %} Projects {% endblock %}
{% block content %}

    <div class="row wrapper">
        <h1 class="heading">Projects</h1>

        <div class="sorting threecol">
            <div class="sleekbox">
                <h4>Affiner ma recherche</h4>
                <p>Mots-clés</p>
                <input type="text" name="keywords-sorting">
                <p>Localisation</p>
                <input class="search-field" id="search-location" type="text" name="location">
                <p>Secteur d'activité</p>
                <p>Type de contrat</p>
                <p>Durée</p>
            </div>
        </div>

        <div class="list-offers eightcol">

            <form action="/projects/search/" class="project-search" method="get">
                {% csrf_token %}
                <input class="search-field" id="search-query" type="text" name="query">
                <input type="submit">
            </form>

            {% include endless_part %}

        </div>
    </div>
{% endblock %}

{% block js %}
    <script src="{{ STATIC_URL }}js/jquery.autoSuggest.minified.js"></script>
    <script src="{{ STATIC_URL }}endless_pagination/js/endless-pagination.js"></script>
    <script>
        $.endlessPaginate({
            paginateOnScroll: true,
            paginateOnScrollMargin: 20
        });

        var search_url = $(".project-search").attr('action');

        function sendSearch(url, data){
            $.get(url, data, function(result){
                $('.thumb').remove();
                $(result).insertAfter(".project-search");
            });
        }

        function collectData(){
            var datas = {};
            $('.data-search-field').each(function(){
                var type = $(this).attr("class").split(" ")[1].replace("queryfield-", "");
                var val = $(this).data('value');
                if(datas[type])
                    datas[type].push(val);
                else{
                    datas[type] = new Array();
                    datas[type].push(val);
                }
            });
            return datas;
        }


        function removeSearch(event){
            $(this).parent().remove();
            sendSearch(search_url, collectData());
            return false;
        };


        function addToSearch(e){
            var id = $(e).attr('id');
            var value = $(e).val();
            id = id.replace('search-','');

            //append data-search-field for the id category
            var data = "<span class='data-search-field queryfield-"+id+"' data-value='"+value+"''>"+value+" <a class='remove-search' href='#' >X</a></span>";
            var newData = $(data).insertAfter(e);

            $(newData).find('.remove-search').on('click', removeSearch);

            //get all datas
            $(e).val('');
            sendSearch(search_url, collectData());
        }


        $("#search-location").autoSuggest("/locations/list/", {minChars: 2, matchCase: true});

        $(".search-field").keypress(function(e) {
            if(e.which == 13) {
                addToSearch(this);
                return false;
            }
        });
    </script>
{% endblock %}
