{% extends "layout/base.html" %}
{% load staticfiles %}
{% load projects %}

{% block title %} {{ profile.slug }}'s profile{% endblock %}

{% block content %}
    {% if profile %}
        <section class="row profile">
            <div class="sleekbox">
                <div class="profile_cover">
                    <img src="{% static "img/profile_cover.jpg" %}" alt="Cover image">
                    <div class="profile_cover_infobar row">

                        <h1 id="name" class="blackTitle">{{ profile.user.first_name }} {{ profile.user.last_name }}</h1>

                        {% if profile.user.id != request.user.id %}
                            {% if following %}
                                 <a class="PTbutton active follow" href="/profile/unfollow/{{profile.id}}/">Suivi</a>
                            {%else%}
                                 <a class="PTbutton unactive follow" href="/profile/follow/{{profile.id}}/">Suivre</a>
                            {% endif %}


                        {% endif %}

                        <ul class="fourcol last profile_stats">
                            <li><span>{{stats.views.hits}}</span>vue{{stats.views.hits|pluralize}}</li>
                            <li>
                                <span>
                                    {% if stats.pushs == 0 %}
                                        0
                                    {%else%}
                                        {{stats.pushs}}
                                    {%endif%}
                                </span>
                                push
                            </li>

                            {% if stats.followers %}
                            <li>
                                <span>{{ stats.followers }}</span>
                                followers
                            </li>
                            {% endif %}

                            {% if stats.following %}
                            <li>
                                <span>{{ stats.following }}</span>
                                following
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                <div class="profile_secondbar">
                    <ul>
                        <li><i class="icon pin"></i> {{ profile.search_location }}</li>
                        <li><i class="icon job"></i> {{ profile.profession }}</li>
                        <li class="last"><a href="{{ profile.url }}" target="_blank" title=""><i class="icon web"></i> {{ profile.url }}</a></li>


                        {% if profile.social_network %}
                        <li class="last">
                        {% for sn in profile.social_network.all %}
                        <a href="{{sn.url}}" title=""><i class="icon {{sn.name}}"></i>{{sn.name}}</a>
                        {% endfor %}
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% if profile.avatar %}<img class="profile_pic" src="{{ profile.avatar.url }}" alt="">{% endif %}
            </div>

            <div class="row profile_menubar">
                <ul class="profile_menu fourcol tabs">
                    <li><a href="#projects" class="active">Projets</a></li>
                    <li><a href="#infos_profile">Parcours</a></li>
                </ul>
                <ul class="tags">
                    {% if stats.tags %}
                    {% for tag in stats.tags %}
                        <li>{{tag.name}}</li>
                    {% endfor %}
                    {% endif %}
                </ul>
            </div>
        </section>


        <!-- TODO : Template Project -->
        {% if projects %}
        <section class="row projects" id="projects">
            {% for project in projects %}
                {% project_mini project forloop.counter|divisibleby:"4" "threecol" %}
            {% endfor %}


        </section>
        {% endif %}

        <section class="row" id="infos_profile">
        {% if profile.education %}
            <h1>Formation</h1>
            {% for education in profile.education.all %}
                {% include "profile/education.html" %}
            {% endfor %}
            {% if user.id == profile.user_id %}
            <a href="#" id="add-education">Ajouter une formation</a>
            <div id="add-education-form" class="row">
                <div class="sixcol">
                    {% include "profile/education_form.html" %}
                </div>
            </div>
            {% endif %}
        {% endif %}

        {% if profile.experience %}
            <h1>Experiences</h1>
            {% for experience in profile.experience.all %}
                {% include "profile/experience.html" %}
            {% endfor %}
            {% if user.id == profile.user_id %}
            <a href="#" id="add-experience">Ajouter une formation</a>
            <div id="add-experience-form" class="row">
                <div class="sixcol">
                    {% include "profile/experience_form.html" %}
                </div>
            </div>
            {% endif %}
        {% endif %}
        </section>

    {% else %}
        <h1> Profile unfound. <h1>
    {% endif %}
{% endblock %}

{% block js %}
<script>
    $(document).ready(function(){

        onoff_button('.follow', 'follow', "Suivi", "Suivre");

        $("#infos_profile").on('click','a.delete-item',function(e){
            var parent = $(this).parent();
            $.post($(this).attr('href'),function(data){ 
                if(data == true){
                    $(parent).fadeOut(function(){
                        $(this).remove();
                    });
                }
            });
            return false;
        });

        $("#infos_profile").on('click','a.edit-item',function(e){
            var parent = $(this).parent();
            $.post($(this).attr('href'),function(data){
                parent.find(".edit-form .sixcol").append(data);
                initDatePicker();
            });
            return false;
        });

        $("#add-education").click(function(e){
            $("#add-education-form").slideToggle();
            e.preventDefault();
        });

        $("#add-experience").click(function(e){
            $("#add-experience-form").slideToggle();
            e.preventDefault();
        });

        $("#add-education-form form, #add-experience-form form").submit(function(e){
            e.preventDefault();
            var data = $(this).serialize();
            var cur = $(this);
            $.post($(this).attr("action"),data).done(function(data){

                if(data[0]==true){
                    console.log("TRUEEEE");
                    edu = data[1];
                    cur.parents('#add-education-form, #add-experience-form').prev().before(edu.data);

                    cur.find("ul.errorlist").each(function(){
                        $(this).remove();
                    });
                    cur.clearForm();
                    cur.parents('#add-education-form, #add-experience-form').slideToggle();
                }else if(data[0]==false){
                    console.log("FALSE");
                    form = data[1];
                    cur.find('.form-content').html(form.data);
                }
            });
        });

        $(".education form, .experience form").live('submit', function(e){
            e.preventDefault();
            var data = $(this).serialize();
            var cur = $(this);
            $.post($(this).attr("action"),data).done(function(data){

                if(data[0]==true){
                    console.log("TRUE");
                    edu = data[1];
                    $temp = $('<div></div>').html(edu.data);
                    cur.parents(".edit-form").parent().html($temp.find("> div").html());
                    initDatePicker();
                }else if(data[0]==false){
                    console.log("FALSE");
                    form = data[1];
                    cur.find('.form-content').html(form.data);
                }
            });
        });

        // $(".following").hover(function(){
        //     $(this).html("Ne plus suivre");
        // }, function(){
        //     $(this).html("Suivre");
        // }
        // );
    });
</script>
{% endblock %}