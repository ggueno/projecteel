{% extends "layout/base.html" %}
{% load staticfiles %}
{% load projects %}
{% load thumbnail %}

{% block title %} {{ user.first_name }}'s profile{% endblock %}

{% block content %}
<section class="row">
    <div class="sleekbox">
        <div class="content">
            {% if edit_title %}
                <h1 class="heading">Editer votre profil</h1>
            {% else %}
                <h1 class="heading">Création de profil</h1>
            {% endif %}
            <div class="row" id="edit_profile">
                <div class="sixcol">

                </div>
                <div class="sixcol last">

                    <ul class="tabs">
                        <li><a href="#etape1"><i class="step-label">1</i>Etape 1</a></li>
                        <li><a href="#etape2"><i class="step-label">2</i>Etape 2</a></li>
                    </ul>

                    {% if form.errors %}
                        <p class="errors">Corrigez les champs erronés suivants: {{ form.non_field_errors }}</p>
                    {% endif %}

                    <form action="/profile/edit/" method="post" class="PTform" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- TAB -->
                        <section id="etape1">
                            <!--
                            {{ form_user.errors }}
                            <div class="row">
                                {{ form_user.as_p}}
                            </div>
                            -->
                            <div>
                                <label for="id_first_name">Prénom</label>
                                {% if form_user.first_name.errors %}
                                <p class="errors">{{ form_user.first_name.errors.as_text }}</p>
                                {% endif %}
                                {{ form_user.first_name }}
                            </div>
                            <div>
                                <label for="id_last_name">Nom</label>
                                {% if form_user.last_name.errors %}
                                <p class="errors">{{ form_user.last_name.errors.as_text }}</p>
                                {% endif %}
                                {{ form_user.last_name }}
                            </div>
                            <div>
                                <label for="">Votre avatar</label>
                                <div class="edit_avatar">
                                        <div class="eightcol">
                                            <span>Actuellement</span>
                                            <div id="avatar_mask">
                                                {% if avatar %}
                                                    <img src="{{avatar.url}}" alt="" class="profile_pic">
                                                {% else %}
                                                    <img src="{{ STATIC_URL }}img/empty_profile.png" alt="" class="profile_pic">
                                                {% endif %}
                                                <img src="{{ STATIC_URL }}img/avatar_mask.png" alt="" id="mask">
                                            </div>
                                        </div>
                                        <div class="fourcol last">
                                            <button class="PTbutton mini" id="avatar_btn">Choisir une image</button>
                                            <button class="PTbutton mini" id="avatar_btn_crop">Valider</button>
                                            {{ form_avatar.as_p }}
                                        </div>
                                </div>
                            </div>

                            {% for network in social_networks%}
                            {{ network }}
                            {%endfor%}

                            <!--
                            <div class="row">
                                {{ form_social.as_p}}
                            </div>
                            -->

                            <div class="footer">
                                <div class="twocol">Etape 1 sur 2</div>
                                <button class="PTbutton next">Etape suivante</button>
                            </div>

                        </section>

                        <section id="etape2">

                            <!--
                            {{ form_applicant.errors }}

                            <div class="row">
                                {{ form_applicant.as_p }}
                            </div>
                            -->
                            <div>
                                <label for="id_name">Name</label>
                                {% if form_applicant.name.errors %}
                                <p class="errors">{{ form_applicant.name.errors.as_text }}</p>
                                {% endif %}
                                {{ form_applicant.name }}
                            </div>
                            <div>
                                <label for="id_description">Description</label>
                                {% if form_applicant.description.errors %}
                                <p class="errors">{{ form_applicant.description.errors.as_text }}</p>
                                {% endif %}
                                {{ form_applicant.description }}
                            </div>
                            <div>
                                <label for="id_url">URL</label>
                                {% if form_applicant.url.errors %}
                                <p class="errors">{{ form_applicant.url.errors.as_text }}</p>
                                {% endif %}
                                {{ form_applicant.url }}
                            </div>
                            <div>
                                <label for="id_profession">Profession</label>
                                {% if form_applicant.profession.errors %}
                                <p class="errors">{{ form_applicant.profession.errors.as_text }}</p>
                                {% endif %}
                                {{ form_applicant.profession }}
                            </div>
                            <div>
                                <label for="id_search_location">Search Location</label>
                                {% if form_applicant.search_location.errors %}
                                <p class="errors">{{ form_applicant.search_location.errors.as_text }}</p>
                                {% endif %}
                                {{ form_applicant.search_location }}
                            </div>
                            <div class="footer">
                                <div class="twocol">Etape 2 sur 2</div>
                                <input type="submit" class="PTbutton" value="Valider">
                            </div>
                        </section>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}
{% block js %}
<script src="{{ STATIC_URL }}js/load-image.min.js"></script>
<script src="{{ STATIC_URL }}js/jquery.iframe-transport.js"></script>
<script src="{{ STATIC_URL }}js/jquery.fileupload.js"></script>
<script src="{{ STATIC_URL }}js/csrf.js"></script>
<script>
    $(document).ready(function(){

        //bind step1 button to trigger tab menu click
        $(".next").on('click',function(e){
            e.preventDefault();
            $("ul.tabs a[href=#etape2]").click();
        });

        $('#avatar_btn').on('click',function(e){
            e.preventDefault;
            $('input[type=file]#id_avatar').trigger('click');
            return false;
        });

        $('#id_avatar').fileupload({
            dataType: 'json',
            url : '/profile/update_avatar/',
            maxFileSize: 1000000,
            acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
            done: function (e, data) {
                $("img.profile_pic").fadeOut(500,function(){
                    $(this).attr('src',data.result.image_src).on('load',function(){
                        $this = $(this);
                        $("#mask").mousedown(function(event){
                            $this.trigger(event);
                        }).fadeIn('fast',function(){
                            $this.removeClass('profile_pic').addClass('new_avatar');
                            console.log($this.width(), $this.height());
                            if($this.width() > $this.height()){
                                $this.removeClass('horizontal').removeClass('vertical').addClass('horizontal');
                            }else{
                                $this.removeClass('horizontal').removeClass('vertical').addClass('vertical');
                            }
                            $this.fadeIn(800,function(){
                                $this.draggable({
                                    containment : buildBoundingBox($(this))
                                });
                                $(".edit_avatar span").html("Positionnez votre image, puis validez");
                            });
                        });
                        $this.off('load');
                    });
                });
                $('#avatar_btn').hide();
                $('#avatar_btn_crop').fadeIn().on('click',function(e){
                    e.preventDefault();
                    var p = $(this);
                    var img = $(".new_avatar");
                    if(img.hasClass('horizontal')){
                        var ratio = img.height()/190
                        var width = Math.ceil(img.width()/ratio);    
                        var height = 190;
                    }else{
                        var ratio = img.width()/190
                        var width = 190
                        var height = Math.ceil(img.height()/ratio);
                    }
                    var data = {
                        'top' : Math.abs(img.position().top),
                        'left' : Math.abs(img.position().left),
                        'width' : width,
                        'height' : height
                    };
                    $(".new_avatar").draggable("destroy");
                    $.post('/profile/update_avatar/crop/',data).done(function(data){
                        $(".new_avatar").attr('src',data.image_src).on('load',function(){
                            $(this).addClass('profile_pic').removeClass('new_avatar').css({'left':0,'top':0});
                        });
                        $('#mask').fadeOut();
                        $('#avatar_btn_crop').fadeOut();
                        $('#avatar_btn').delay(1000).fadeIn();
                        $(".edit_avatar span").html("Votre nouvel avatar");
                    });
                    $(this).off('click');
                });
            },
            // progressall: function (e, data) {
            //     var progress = parseInt(data.loaded / data.total * 100, 10);
            //     $('#cover_loading').css(
            //         'width',
            //         progress + '%'
            //     );
            // }
        });


        $("#id_search_location").autoSuggest("/list/location", {
            asHtmlID: "id_search_location__tagautosuggest",
            startText: {% if form_applicant.search_location%}"{{ form_applicant.search_location.value }}"{%else%}"Tapez un lieu ici"{%endif%},
            emptyText: "Aucun résultat",
            limitText: "Vous ne pouvez plus ajouter de lieu",
            preFill: "",
            queryParam: 'q',
            retrieveLimit: 20,
            minChars: 1,
            neverSubmit: false,
            showResultList : true,
            resultsHighlight : true,
            selectionAdded: function(elem){
                elem.hide();
            },
            resultClick: function(data){
               $("#id_search_location__tagautosuggest").val(data.attributes.value)
           },

        });

        function buildBoundingBox(img){
            console.log(img);
            var W = img.width();
            var H = img.height();
            var boundLeft = 0-(W-190);
            var boundTop = 0-(H-190);
            var visorX = $("#mask").offset().left;
            var visorY = $("#mask").offset().top;
            return [visorX + boundLeft,visorY + boundTop,visorX,visorY];
        }

    });
</script>
{% endblock %}